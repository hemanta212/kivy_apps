name: Build
on:
  push:


jobs:
  setup:
   runs-on: ubuntu-latest
   strategy:
     matrix:
       project: ['hello_world', 'http_requester', 'pong', 'whatsapp_ui']

   steps:
     - run: |
          sudo apt-get update
          sudo pip install --user --upgrade pip setuptools
          sudo pip install --upgrade cython==0.28.6
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install build-essential ccache git libncurses5:i386 libstdc++6:i386 libgtk2.0-0:i386 libpangox-1.0-0:i386 libpangoxft-1.0-0:i386 libidn11:i386 python2.7 python2.7-dev openjdk-8-jdk unzip zlib1g-dev zlib1g:i386
          pip install --upgrade buildozer

     - name: Checkout Keystore repo
       uses: actions/checkout@v2
       with:
         repository: hemanta212/personal
         token: ${{ secrets.REPO_ACCESS_TOKEN }}
         ref: "refs/tags/vkivyapp"
         path: 'personal'

     - uses: actions/checkout@v2
       with:
         path: 'app'

     - run: |
          export PATH=$PATH:~/.local/bin/
          cd app
          mkdir rel

          cd ${{ matrix.project }}
          export P4A_RELEASE_KEYSTORE=../../personal/credentials/keystores/kivyapplicationkey.keystore
          export P4A_RELEASE_KEYSTORE_PASSWD=${{secrets.KEYSTORE_PASS}}
          export P4A_RELEASE_KEYALIAS_PASSWD=${{secrets.KEYSTORE_PASS}}
          export P4A_RELEASE_KEYALIAS=kivykey

          buildozer -v android release 
          mv bin/*.apk ../rel/${{ matrix.project }}_armeabi-v7a-release.apk 

     - uses: actions/upload-artifact@v1
       with:
         name: ${{ matrix.project }}_armeabi-v7a-release.apk
         path: app/rel/${{ matrix.project }}_armeabi-v7a-release.apk

  release:
    needs: setup
    runs-on: ubuntu-latest
    steps:
     - uses: actions/checkout@v2
       with:
         path: 'app'

     - run: |
         cd app
         mkdir rel/

     - uses: actions/download-artifact@v1
       with:
         name: hello_world_armeabi-v7a-release.apk
         path: rel/

     - uses: actions/download-artifact@v1
       with:
         name: pong_armeabi-v7a-release.apk
         path: rel/

     - uses: actions/download-artifact@v1
       with:
         name: http_requester_armeabi-v7a-release.apk
         path: rel/

     - uses: actions/download-artifact@v1
       with:
         name: whatsapp_ui_armeabi-v7a-release.apk
         path: rel/

         
     - name: Release
       uses: softprops/action-gh-release@v1
       if: startsWith(github.ref, 'refs/tags/')
       with:
         files: |
             rel/whatsapp_ui_armeabi-v7a-release.apk
             rel/pong_armeabi-v7a-release.apk
             rel/http_requester_armeabi-v7a-release.apk
             rel/hello_world_armeabi-v7a-release.apk
         body_path: app/CHANGELOG.txt
         draft: true
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
